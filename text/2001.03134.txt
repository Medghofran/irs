Draft version January 10, 2020 Preprint typeset using LATEX style emulateapj v. 12/16/11  SENSOR DISTORTION EFFECTS IN PHOTON MONTE CARLO SIMULATIONS  J. R. Peterson1, P. O’Connor2, A. Nomerotski2, E. Magnier3, J. G. Jernigan4, J. Cheng1, W. Cui1  ,  A. Rasmussen6, G. Sembroski1  5, E. Peng1,  0 2 0 2     n a J    9      ]  M  I .  h p - o r t s a [      1 v 4 3 1 3 0  .  1 0 0 2 : v i X r a  Department of Physics and Astronomy, Purdue University, West Lafayette, IN 47907, USA  Brookhaven National Laboratory, Upton, NY 11973, USA  Department of Astronomy, University of Hawaii, Honolulu, HI 96822, USA  Eureka Scientiﬁc, Oakland, CA 94602, USA  Tsinghua Center for Astrophysics, Department of Astronomy Tsinghua University, Beijing 100084, China and  Stanford Linear Accelerator Laboratory, Menlo Park, CA 94025, USA  Draft version January 10, 2020  ABSTRACT  We present a detailed method to simulating sensor distortions using a photon and electron Monte Carlo method. We use three dimensional electrostatic simulations to parameterize the perturbed electric ﬁeld proﬁle for non-ideal sensor details. We follow the conversion of simulated photons, and the subsequent response of the converted electrons to the electric ﬁeld pattern. These non-ideal sensor details can be implemented eﬃciently in a Monte Carlo approach. We demonstrate that the non-ideal sensor distortions have a variety of observable consequence including the modiﬁcation of the astrometric pattern, the distortion of the electron diﬀusion size and shape, and the distortion of ﬂats. We show analytic validation of the diﬀusion physics, reproduce two kinds of edge distortion, and show qualitative validation of ﬁeld-free regions, lithography errors, and fringing. We also demonstrate that there are two related eﬀects of doping variation having diﬀerent observable consequences. We show that ﬁeld distortions from accumulated electrons lead to intensity-dependent point-spread-functions and the sub-linear variance in ﬂats. The method is implemented in the Photon Simulator (PhoSim) and the code is publically available. Keywords: telescopes– instrumentation: detectors–  1. INTRODUCTION  and  optical  interpreting X-ray  2007; astronomical  Peterson, Marshall, & Andersson  Simulations have become increasingly more important (Peterson, Jernigan, & Kahn in 2007; 2004; Davis et al. Andersson, Peterson, & Madejski 2012) observations (Ackermann et al. 2012; Lane, Glindemann & Dainty 1992, Ellerbroek 2002; Le Louarn 2002; Britton 2004; Jolissaint 2010; Bertin 2009; Dobke et al. 2010; Peterson et al. 2015, Rowe et al. 2015). The consid- erable complexity of the atmosphere, telescope, and camera imprint many systematics on the measurements of astronomical objects. Some recent simulators use parameterized models of point-spread-functions to gen- erate synthetic images (Bertin 2009; Dobke et al. 2010; Rowe et al. 2015). In our previous work (Peterson et al. 2015, Peterson et al. 2019, Burke et al. 2019), however, we developed a ab initio physics simulator that tracks photons and the subsequent converted electrons through the atmosphere, telescope, and camera called the Photon Simulator (PhoSim). PhoSim is publically available at: https://bitbucket.org/phosim/phosim release/wiki/Home. It is important to represent both the photon and elec- tron interactions as well as the interacting components (atmosphere, telescope, and camera) using appropriate physics. In Peterson et al. (2019), we implemented the complete physics describing the deformation of the optics to expand that work. Another important area of simulation is the individual sensors in a camera. In particular, in Peterson et al. 2015, we noted that distortion of electric ﬁeld lines from their ideal shape  peters11@purdue.edu  were important but did not describe how to represent them. These distortions of electric ﬁeld and other com- plications and how they are represented using formal Photon Monte Carlo methodology are described in this work.  Non-ideal sensor eﬀects form some of  the most diﬃcult eﬀects to properly calibrate and mitigate (Downing et al. 2006; Stubbs 2014;Antilogus et al. 2014; Plazas, Bernstein, & Sheldon 2014; Gruen et al. 2015; Tyson 2015, Astier 2015, Rasmussen 2015, Magnier et al. 2018); Astier et al. 2019). The point spread function (PSF) size and shape, the diﬀerential astrometric pat- tern, and the diﬀerential photometric pattern are all af- fected by the physics of non-ideal sensor features. These systematic errors tend to be hard to remove, because since the sensor is, by deﬁnition, in the image plane. Because of that, the eﬀects can aﬀect every source or every pixel or even part of a pixel diﬀerently. The non- ﬂatness of the sensor, the distortion of parallel ﬁeld lines, contamination, and other imperfections all result in com- plex systematics in the PSF, astrometry, and photometry calibrations. Most of these eﬀects depend on the photon wavelength as well as the source location, since the con- version depth is a strong function of wavelength. Below, we demonstrate that a proper way to understand these eﬀects and eventually calibrate them is to follow a Pho- ton Monte Carlo approach with the appropriate approx- imations of electrostatic physics describing the sensor. We are also particularly interested in coupling the sen- sor distortions in an eﬃcient numerical approach, so we can simulate large surveys.  The paper is organized as follows. In §2, we describe the implementation of non-ideal sensor physics in the  2  Peterson et al.  PhoSim code using Photon Monte Carlo techniques. In §3, we then describe the observational eﬀects of the sen- sor physics.  2. SENSOR DISTORTIONS  In this work, we are concerned with the implemen- tation of non-ideal aspects of sensors that ultimately impact astronomical measurements. For simplicity, we assume it is a modern charge-coupled device (CCD) constructed out of a rectangular slab of Silicon (see Janesick & Elliott 1992, Holland et al. 2003). Some of this work can be generalized to diﬀerent materials and readout schemes as described in Burke et al. (2019). We focus on non-ideal details which appear endemic to all modern sensors, and generally ignore the various ways that sensors could operate ineﬀectively but generally not common to all devices. Some of these will be more im- portant for certain applications. In particular, some of these details are more relevant for thicker (> 50 microns) devices and others for thinner (< 50 microns) devices, so this parameter is studied in more detail in §3. Through- out this paper, we refer to the dimension parallel to the intended photon propagation as the z-axis and the other two dimensions as x and y. In the simulation, the po- sition of the sensor can be oﬀset in all three dimensions (dx, dy, and dz) and the sensor can be rotated in all three dimensions from the ideal orientation. All of these per- turbations simply aﬀect the intercepts of the incoming photons. In addition, the surfaces describing the rectan- gular slab can be distorted from their ideal ﬂat shape. We represent this distortion by a series of polynomials, either Zernike or Chebyshev, that locally describe the surface at a given location, z(x, y). The geometry and shape have an eﬀect on the various physics that we de- scribe below.  2.1. Photon Propagation and Conversion  Within the Silicon, we model the path of the photon as described in Peterson et al. (2015). This includes the wavelength-dependent refraction, which alters the ray trajectories. The temperature-dependent mean free path is calculated and the photon is propagated along a path based on a random realization of the mean free path. There are two complications to the photon conversion. One is that interference (fringing) occurs and modiﬁes the reﬂection probabilities from the surfaces. The sec- ond is that the photon may convert in a region where the electron cannot reach the readout and will likely be reabsorbed. Note that throughout this paper, for sim- plicity we assume that the photon converts into an elec- tron rather than a hole, but there is no loss of generality and the expressions for electron mobility are replaced by hole mobility in hole-producing devices in PhoSim.  As described in Peterson et al. (2015), we implement fringing by performing a one-dimensional EM calculation if the photon reaches the back surface. We expand that calculation to consider multiple relective layers of the sensor. We include both bare Silicon in the slab as well as an oxide layer. Then the reﬂectivities of the three boundaries are given by  ρ1 =  cosp θv − nSi cosp θSi cosp θv + nSi cosp θSi  ρ2 =  nSi cosp θSi − nOx cosp θOx nSi cosp θSi + nOx cosp θOx  ρ3 =  nOx cosp θOx − cosp θv nOx cosp θOx + cosp θv  where θv, θSi, and θOx are the incidence angles in the the vacuum, Silicon, and oxide layer, respectively, p is the polarization (represented as either +1 or -1), and nSi and nOx are the wavelength-dependent indices of refraction. Then the reﬂection ratios, Γ1 and Γ2 are given by  Γ2 =  Γ1 =  ρ2 + ρ3e−2iδ2 1 + ρ2ρ3e−2iδ2 ρ1 + γ2e−2iδ1 1 + ρ1γ2e−2iδ1  where δ1 and δ2 are given by  δ1 =  2π λ  δ2 =  2π λ  tSinSis1.0 − tOxnOxs1.0 −  sin2 θv  n2 Si  sin2 θv n2  Ox  where tSi and tOx are the local layer thicknesses. Then the reﬂection probability in one segment is given by 1 + 1 − ρ2 Γ2 3. If the photon is not converted in the dis- tance it is predicted to travel via the photon conversion calculation, then we iteratively repeat the calculation to simulate multiple reﬂections.  In many devices, particularly back-illuminated ones, there may be a ﬁeld-free region above the depleted vol- ume. Thus, photons that convert in the ﬁeld-free region do not ever result in a photoelectron reaching the read- out. The ﬁeld-free region can have a complicated spa- tial structure depending on how the Silicon is thinned for back illuminated devices. Laser annealing techniques in particular result in a structured non-uniform pattern that follows the cadence of the rectangular laser anneal- ing beam’s footprint. It is straight-forward to represent this in a Monte Carlo method. We simply deﬁne a vol- ume in three-dimensions according to a likely cadence of the beam’s footprint where there is no ﬁeld. Then if the photon converts in this volume, we remove the electron from the simulation. We therefore assume that the electron does not reach the readout in order to re- produce the spatial variation, however, in real devices it is possible that the electron could reach the readout in other pixels depending on the exact ﬁeld structure. This naturally results in the complex wavelength-dependence, since shorter wavelength photons are much more likely to convert in this relatively small volume.  To model this, we consider the path of a laser annealing footprint tilted at an angle, θ, with respect to the pixel grid, so that pixel positions are multiplied by a 2x2 ro- tation matrix. We then take the modulus of the rotated pixel positions with the footprint lengths (xL, yL) with a subtracted overlap (xo, yo). Then if the pixel is within the footprint length, we deﬁne the dead layer depth as d. If the pixel is within one overlap region, we double the depth and if it is within two of the overlap region we triple the depths. We repeat the whole process for  Sensor Distortion Effects  3  multiple passes of the annealing process. The result of this, is that there is a small ﬁeld-free region at the top of the sensor with a complex “brick wall” pattern as we show in §3. We then destroy electrons that are generated in the ﬁeld free region.  2.2. Electrostatic Simulations and Electron Diﬀusion  In Peterson et al. (2015), the vertical component of the  electric ﬁeld was calculated as  Ez(z) =  V tSi  +  e  ǫSi Z z  zcoll  dznd(z)  where V is applied potential, tSi is the thickness, ǫSi is the permittivity in Silicon, e is the electron charge, nd is the doping density. We pre-calculate this at various numerical depths in the sensor slab.  The diﬀusion is then given by thep2µkT /etcoll where  µ is the electron mobility which is a function of tempera- ture and electric ﬁeld, k is Boltzmann’s constant, T is the temperature, and e is the electron charge. The collection time, tcoll, is given by another piecewise integral,  Z z  zcoll  dz  µEz(z)  To represent some non-ideal sensor properties, the one dimensional solution above is insuﬃcient. Instead, we have to determine the full three-dimensional electrostatic solution. To implement this numerically, we consider the electrostatic potential in a three-dimensional cartesian coordinate system, φ(x, y, z). We then solve Poisson’s electrostatic equation,  ∇2φ = −  ρ ǫSi  where ρ is the charge density, and ǫSi is the permittivity. We construct the slab of Silicon consisting of a series of rectangular volume elements and allow for a diﬀerent width in dx and dy than the vertical element in dz. We then make the total number of elements equal to N in each dimension and N 3 in the overall volume.  To solve the equation numerically, we randomly choose a point in the three dimensional volume. We then eval- uate the accuracy of the Poisson equation by ﬁrst calcu- lating the numerical derivative in each of the three di- mensions and calculate the diﬀerential between that and the charge density divided by the permittivity as  e0 =  φ(x + dx, y, z) + φ(x − dx, y, z) − 2φ(x, y, z)  dx2  +  φ(x, y + dy, z) + φ(x, y − dy, z) − 2φ(x, y, z)  dy2  +  φ(x, y, z + dz) + φ(x, y, z − dz) − 2φ(x, y, z)  dz2  +  ρ(x, y, z)  ǫ  We then evaluate the error, e+, when a small amount, δ is added to φ(x, y, z). We also evaluate the error, e−, when a small amount is subtracted from φ(x, y, z). We then modify φ according to a double Metropolis-Hastings (Metropolis et al. 1953, Hastings 1970) criterion. If e+ is less than e− then we accept e+ if it is less than e0 or if a  e+−e0  α  . Similarly, uniform random deviate is less than e− if e− is less than e+ then we accept e− if it is less than e−−e0 e0 or if a uniform random deviate is less than e− . After choosing all of the points in the lattice, we set the value of δ to be equal to 10−6 i mi where i is the iteration, and mi is the maximum iteration. We set the value of α to be equal to a fraction f of the average current error. We achieved robust results with mi of 2000, and f set to 0.1.  α  For the boundaries, we consider both Dirichlet and Neumann conditions for the six surfaces. The Dirich- let conditions are accomplished by simply setting it to a given constant potential on the top and bottom surfaces. For the Neumann boundary conditions, if the surface is in the y-z plane, then a point on the surface is given by  φ(x, y, z) = φ(x + dx, y, z) −  σ ǫ  dx  where σ is the surface charge, and for the other surfaces the coordinates are exchanged. We then iterate the value of the potential on all points where the boundary condi- tions do not apply.  To compute the electric ﬁeld, we evaluate the numeri-  cal derivative of the electric potential as  Ex =  Ey =  Ez =  φ(x + dx, y, z) − φ(x − dx, y, z)  2dx  φ(x, y + dy, z) − φ(x, y − dy, z)  2dy  φ(x, y, z + dz) − φ(x, y, z − dz)  2dz  This electric ﬁeld can then be used in the calculation  of the electron path.  As discussed in Peterson et al. 2015, the lateral shift  of the electron due to a transverse ﬁeld is given by  ∆x =Z dz ∆y =Z dz  Ex(x, y, z) Ez(x, y, z)  Ey(x, y, z) Ez(x, y, z)  where the integral should be evaluated from the conver- sion point to the collection surface. Similarly, the diﬀu- sion discussed above can be calculated based on an in- tegral at the photo-electron conversion point. However, if the electron drifts laterally by a signiﬁcant amount (a pixel) either from diﬀusion or lateral ﬁelds, then it makes it diﬃcult to evaluate this integral for all cases. This only occurs for signiﬁcant changes to the ﬁeld pro- ﬁle that occurs within a pixel (e.g. see the discussion on accumulated charges below), but is not signiﬁcant for many details. In order to evaluate this accurately for all cases, it is straightforward to break up both the diﬀu- sion integral as well as the lateral shift integrals above in a piece-wise manner. Then, the path of the electron is broken into a series of vertical segments where both the lateral shift for that segment as well as the overall diﬀusion for that segment is used to predict a new (x, y) position. The segmentation of the calculation, however, does not have to represent the real random walk of the  4  Peterson et al.  electron. In practice, splitting the vertical slices into 4 segments achieves essentially the same numerical accu- racy as an arbitrarily large number. Ultimately, the ac- curacy depends on the inhomogeneity of the electric ﬁeld which we discuss in the following sections.  2.3. Edge Distortion  The simpliﬁed 1-D calculation of the electric ﬁeld as- sumes that we have an inﬁnite slab of Silicon and there- fore no distortion near the edge of the Silicon. However, in various device designs is likely that the electric ﬁeld is distorted near the edge where it will be less constrained by the conducting surfaces. This can be simulated as a surface charge on the edge surfaces that are not held at constant potential. If we add a surface charge, σ, on the edge surfaces using the Neumann condition, we ﬁnd the electric ﬁeld can be parameterized by  ~E = e−  xn  d  σ  where nd is the average bulk doping density and x is the distance from the edge. Thus, the lateral ﬁeld decays from the edge. The direction of the ﬁeld is perpendicular to the edge and we use two components in the corners of the device.  2.4. Doping Variation  In CCD manufacturing when the Silicon boule is formed that is eventually used to make the individual sensor wafers, the molten Silicon is mixed with a Boron or Phosphorus dopant and then it crystallizes as it is cooled while rotating. The dopants, however, have a dif- ferent segregation coeﬃcient. If the thermal axis (axis of thermal symmetry) is not perfectly aligned with the rotational axis then the dopant while not be distributed uniformly. Since the Silicon boule is continually rotated, the non-uniformity will tend to have a ring-like struc- ture as it cools radially. This leads to a “tree-ring” like variation of the dopant.  The rings structure is complex since it depends on in- terplay between the crystallization, rotation, and the dif- ferent materials. Therefore the pattern can only be in- ferred indirectly (as discussed in §3). However, given a parametrized doping pattern we can correctly predict the response to the electric ﬁeld and then follow the re- sponse to the electrons. We found that empirically we can describe a range of doping variations by  n(r) = n0 1 +  N  Xi=1  α √N  sin(cid:18) 2πr  Pie−r/r0  + φi(cid:19)!  where Pi is the period, φi is the phase, r0 attenuates the period, n0 is the nominal doping density, and α is the overall amplitude. The multiple components are used to empirically match realistic doping variations. The indi- vidual period is chosen from a uniform distribution be- tween a lower period and a higher period. The ampli- tude is approximately constant, but can also be further described by a function of form  α = t1 +  1 − t1 1.0 + e−  r−rr  tr  where t1, tr, and rr are empirical parameters.  The dopant variation has two important consequences. One is that it creates a lateral ﬁeld having a sinusoidal variation between the two surfaces. A second conse- quence is that the overall level of charge diﬀusion will also vary because the strength of the vertical ﬁeld is af- fected by the level of doping as described in §2.2. For the ﬁrst eﬀect, we found an electric solution from the three dimensional Poisson simulation above by including a sinusoidal variation in dopant density (uniform in the z-direction). The amplitude of the lateral ﬁeld is given by  A =  dn dx  n  < n >  tSi < Pi >  e  (2π)2ǫSi  where dn dx is the numerical derivative of the doping map, n <n> is the relative amplitude of the doping map, Pi is the average local period, tSi is the device thickness, e is the electric charge, and ǫSi is the permittivity.  For the second eﬀect, we simply store the dopant den- sity at all (x, y) and then use a locally diﬀerent diﬀu- sion estimate. The combined result of both eﬀects is then complex, because the diﬀusion distortion and lat- eral shifts are occuring simultaneously during the simu- lation. We can separate the observable consequences of each eﬀect, since we can turn each on and oﬀ as described in §3.  2.5. Accumulated Charges  It has been noted that the electrons collected in pixel can signiﬁcantly alter the local electric ﬁeld (Downing et al. 2006, Rasmussen 2015, Astier et al. 2019). This then aﬀects the ﬁnal location of subsequent electrons. This has a number of observable consequences that we explore in §3. To simulate this, we performed various electrostatic simulations with the three dimen- sional method described above. We performed a small- scale simulation where a charge was placed at the collec- tion surface. We then solved the electrostatic equation and studied the resulting ﬁeld. We found that the mag- nitude of the perturbation of the electric ﬁeld due to the accumulated charge can be described by a diluted Coulomb like solution as  | ~E| =  f e  4πǫSi(z2 + r2)  where f is the dilution factor that is determined numer- ically. Note that this superposition solution is not per- fect (i.e. f 6= 1) because the ﬁeld still has to satisify the boundary conditions. However, we are mainly interested in having an approximate solution, because the goal is simply to predict which of the subsequent electrons will jump to a diﬀerent pixel than they would have with- out the accumulated charge existing. For large values of r, this solution is not appropriate and the ﬁeld will ex- ponentially decay (Pumplin 1969), but for the adjacent pixels where r is a small fraction of the sensor thickness this approximation is valid.  An additional detail that is important to include is that the accumulated charge does not occupy a single point at the center of the pixel. To implement this, we include two parameters that describe the standard deviation of the charge in the potential well, σx and σy. Then the  Sensor Distortion Effects  5  pixel shift due to an accumulated charge is given by ﬁrst computing the function as in Peterson et al. (2015) as  fi(r, z) =Z z+dz  z−dz  Ei(r, z) Ez(r, z)  dz  where i is either the x or y component, dz is a numerical step that computes the local kick at each segment of the sensor slab, and r is the radial distance. Then the lateral kick is given by evaluating this function  δXi = Zfi(rr2 +  x2 r2 σ2  x +  y2 r2 σ2  y, z)  where Z is the current accumulated charge. Then, we evaluate this kick for not just the accumulated charge in the pixel where the electron is currently, but we also per- form the same calculation at all the neighboring pixels. In practice, most observable consequences are captured by evaluating the neighbors in a 3x3 grid. However, some correlations in bright ﬂats would require a larger grid of pixels. The advantage of this calculation is that it can be done eﬃciently on a photon by photon basis. The ﬁeld will grow as the charges start accumulating in the simu- lation, but the calculation of f can be done on a dense numerical grid once in the entire simulation. This makes the Monte Carlo of this complex detail both eﬃcient and accurate. Charge stops that prevent the electrons from bleeding into neighboring rows are implemented as a line charge with the same formalism, but do not have a large eﬀect on ﬁnal electron locations.  2.6. Lithography Errors  The pixels in a sensor may not be perfectly placed in a geometric grid. Most likely, this can be represented in errors in both column locations and row locations. To implement this, we place a random error in the physical size of the ﬁnal pixels in both the row and the columns. Then when the electron reaches the collection plane, its ﬁnal pixel is determined by the perturbed pixel grid that is modiﬁed by the random lithography errors.  3. SENSOR OBSERVATIONAL EFFECTS  There are a number of observational consequences to the implemented physics described in §2. In many cases, there are actually multiple observational consequences to a single physical eﬀect. Following, we demonstrate the observational eﬀects and describe various validation calculations.  3.1. Photon and Electron Interactions  In Figure 1, we show the overall basic interactions in the simulation by simulating a dozen of photons. The path of the photons before reaching the silicon and then the much narrower cone due to refraction of the photons while propagating in the Silicon is shown. Then the pho- tons propagate for a random amount according to the photon conversion physics. After interaction the elec- trons are propagated in segments to represent the vari- able diﬀusion at each height in the Silicon. Finally, the electrons reach the readout plane at the top of Figure 1.  3.2. Diﬀusion Validation  We evaluate the accuracy of the diﬀusion calculation in Figure 2. We ﬁrst simulate a set of photons as in Figure 1. We set the index of refraction in the Silicon eﬀectively to inﬁnity, so the photons are incident normal to the Silicon. This enables us to isolate the eﬀect of diﬀusion. We perform four sets of simulations: 1) photons with wavelength of 350 nm and a 100 micron detector at - 100 Celcius, 2) photons with wavelengths of 350 nm and a 10 micron detector at -100 Celcius, 3) photons with wavelength of 950 nm and a 100 micron detector at - 100 Celcius, and 4) photons with wavelengths of 350 nm and a 100 micron detector at -80 Celcius. With these simulations, we also turned oﬀ some of the physics to validate the individual parts. To compare the diﬀusion calculation with an analytic prediction, we ignored 1) the eﬀect of the doping on the electric ﬁeld proﬁle, 2) the electric ﬁeld dependence of the mobility by setting it to the ﬁeld-free value, and 3) the eﬀect of velocity saturation on the electron mobility. Then the standard deviation of the lateral diﬀusion is given by  σ =r 2kT  eV  t  where V is the bias voltage, T is the temperature, k is Boltzmann’s constant, e is the electron charge, and t is the sensor thickness. The four simulations show per- fect agreement with the analytic prediction at all bias voltages. By using the electric ﬁeld dependence of the mobility the overall diﬀusion is increased signiﬁcantly as expected since the mobility vertically decreases which in- crease the collection time. The eﬀect of doping is visible at low bias voltages for the 100 micron simulations, since the overall electric ﬁeld proﬁle will be most inﬂuenced when V d is small. Conversely, the eﬀect of the velocity saturation is most visible at high bias voltage for the 10 µm simulation, since the velocity of the electron will only approach the saturation velocity when V  d is large.  3.3. Edge Distortion Eﬀects  The eﬀect of the edge distortion can be seen by sim- ulating the eﬀect of diﬀerent eﬀective surface charge as seen by two sets of simulations. We set the surface charge of 2 × 1010 and −2 × 1010 electrons cm−2 and generate a ﬂat where photons are produced at a range of wave- lengths and at all incident angles. The negative surface charge implies there is repulsive force near the boundary whereas a positive surface charge is an attractive force due to the net electric ﬁeld outside the volume. The de- crease in ﬂux near the edge is then seen in Figure 3. The eﬀect of positive surface charge leads to a gradual roll oﬀ near the edge, whereas the eﬀect of negative surface leads to an excess of ﬂux several pixels near the edge and an asymmetric fall oﬀ on either side. The simplic- ity of the positive charge fall oﬀ is simply due to the electrons being pulled away from the imaging Silicon, whereas the asymmetric pattern of the negative surface charge is due to how many electrons can be pushed from the non-imaging area and diﬀering amounts. The latter eﬀect was qualitatively observed in Estrada et al. (2010). The eﬀect of the edge roll oﬀ also has a variety of consequences in PSF patterns near the edge. We sim-  6  Peterson et al.  Figure 1. Basic photon and electron interactions in the Simulation. The photons are propagated from the bottom of the ﬁgure in a cone following the f/# of our generic telescope (purple). The interaction with the silicon occurs at the convergence point, and a narrower cone due to the index of refraction of the Silicon is shown in black rays. Photon conversions into electrons are shown by the red dashed lines. The electrons then diﬀuse in numerical segments until they reach the readout plane (light blue). Note this plane is tilted from our viewpoint.  ulate a grid of point sources across the edge and then measure their PSF properties. Figure 4 shows the in- crease in PSF size near the edge. Similarly, the PSF acquires an elliptical shape perpendicular to the edge in response to the pulling or pushing of the charge as shown in Figure 5. Finally, the astrometric position of the PSFs becomes distorted from the original grid as shown in Figure 6. The negative surface charge com- presses the astrometric pattern, whereas the positive sur- face charge stretches the grid. These results are consis- tent with Plazas, Bernstein, & Sheldon (2014) edge ob- servations with DECam that observed a 10% change of ﬂat intensity near the edge and a corresponding 1.5µm astrometric shift. We observe a similar ratio with a 100% ﬂat intensity change and a 25 µm astrometric shift, so the surface charge would be consistent with a factor of 10 to 15 smaller implying a eﬀective surface charge of approximately 2 × 109 electrons cm−2.  3.4. Qualitative Flat Variation  A number of eﬀects are most visible by the modulation of a ﬂat. We perform a series simulation of large number of photons with a uniform set of angular incidence an- gles. In order to evaluate the ﬁeld free implementation described in §2.4, we simulate a monochromatic ﬂat at 350 nm. At this wavelength, the mean free path of the photons in the Silicon is small and therefore the eﬃciency of the photon conversion will map the ﬁeld free pattern. In Figure 7, we show the ﬂat and the two layer overlap- ping brick wall pattern. This is qualitatively similar to what is found in Wei & Stover (1998).  The eﬀect of row and column lithography errors can be see by simulating a ﬂat at a mid-range wavelength. In  Figure 7, we simulate a 500 nm monochromatic ﬂat. The column and row striping is visible with a 0.3% variation in the x-direction and 0.2% variation in the y-direction. This is enough to make some electrons near the border shift to a neighboring pixel that they would not have oth- erwise. Also visible in this image is the tree ring pattern that we discuss in the following section.  Finally, the eﬀect of fringing can be visualized by sim- ulating a long wavelength monochromatic ﬂat. In Fig- ure 7, we simulate a 950 nm monochromatic ﬂat. The in- terference pattern follows the variation in surface height.  3.5. Two Tree Ring Eﬀects  There are two physical eﬀects that result from the dop- ing variation present in devices: 1) the perturbed lateral electric ﬁeld and 2) the modiﬁcation of the diﬀusion by changing the vertical electric ﬁeld proﬁle. Magnier et al. (2018) hypothesized that the diﬀusion variation by the modiﬁcation of the electric ﬁeld could be an important contributor to PSF size variation. We can determine the observable consequences by isolating each eﬀect. We ex- aggerate the eﬀect for illustrative purposes by using a 50% doping variation amplitude. The average tree ring period is set to 2 mm with a variation of 0.4 mm. In Figure 8, we measure the eﬀective size of the diﬀusion by simulating a grid of point sources. The lateral eﬀect does not show evidence of the tree ring pattern, whereas the vertical eﬀect clearly shows the tree ring pattern. In Figure 10, we measure the astrometric displacement from the nominal grid. The lateral eﬀect shows the tree ring pattern, whereas the vertical eﬀect does not. Similarly, in Figure 9 we measure the ellipticity and show that the tree ring pattern is only present with the lateral eﬀect.  Sensor Distortion Effects  7  Figure 2. The full width at half maximum of the electric charge diﬀusion as the electrons reach the readout in various conﬁgurations. The diﬀusion size vs. bias voltage is shown for: a simulation of 350 nm light through a 100 µm thick device at -100 Celsius (black), 350 nm light through at 10 µm thick device at -100 Celsius (red), 350 nm light through a 100 µm thick device at -80 Celsius (blue), and 950 nm light through a 100 µm thick device at -100 Celsius (green). The diﬀerent symbols correspond with levels of physics ﬁdelity. The diamonds ignore the eﬀects of: 1) the doping, 2) the velocity saturation, 3) and the decrease in mobility due to the vertical electric ﬁeld strength. The triangles add the decrease in mobility due to the ﬁeld strength, the squares add the eﬀect of the doping, and the cross adds the eﬀect of the velocity saturation. The lines show the analytic prediction in the limit of short wavelength light.  A simulated ﬂat in Figure 11, the lateral eﬀect causes the ﬂat variation, whereas the vertical eﬀect does not. Therefore, the lateral eﬀect is responsible for astrometric shifts, ﬂat variations, and PSF ellipticties, whereas the vertical eﬀect leads to the variation of the PSF size. Sim- ilar tree ring patterns were also studied in Beamer et al. (2015).  We can compare the magnitude of these two tree ring eﬀects with published results. We do not know intrin- sically the dopant variation, α, but note that the two lateral and vertical eﬀects scale diﬀerently. The magni- dE⊥ dα  tude of the lateral ﬁeld eﬀect is proportional to αt where t is the device thickness. The parallel and per- pendicular ﬁeld is complex and depend on the doping level, bias voltage, and thickness. Conversely, the rela- tive change in the diﬀusion size due to the vertical eﬀect  Ek  dE  k dα  Ek  . In the simulations we used 50% is proportional to α doping variation and 100 µm thickness. This resulted in astrometric shifts of 10 µm, relative diﬀusion varia- tions of 10%, and a ﬂat variation of 12%. Magnier et al. (2018) measured astrometric shifts of 0.5 µm and ﬂat variations of 0.4%. Note that despite those are both from the lateral eﬀect, there is a similar relative factor when comparing with the simulations (20 and 30 times, respectively). Magnier et al. (2018) measured a smear amplitude (square of the second moment), s, of 10 µm2 for a typical PSF size, σ, of 16 µm. So the relative dif- fusion variation would be ∆σ  σ = 1  σ (cid:0)√σ2 + s − σ(cid:1) = 2%.  This is about a factor of 5 smaller than the simulation and signiﬁcantly less than the factor of 25 for the lat- eral eﬀect implying a stronger parallel ﬁeld dependence. The stronger ﬁeld dependence in this devices deserves further study. Similarly, Plazas, Bernstein, & Sheldon (2014) and Bernstein et al. (2017) with DECam mea- sure a ﬂat variation of 3% and a 3 µm astrometric shift. These results have a similar consistent relative factor of 3 compared to the simulations. The diﬀusion variation was not observed, but this should be more diﬃcult to observe since DECam is much thicker at 250 µm.  We also can evaluate the wavelength-dependence of these eﬀects. In Plazas, Bernstein, & Sheldon (2014) and Bernstein et al. (2017), the residual astrometric, photometric, and ﬂat amplitude all decrease at long wavelength in observations with DECam. This is because the photons convert at greater depth, and the eﬀects of the lateral ﬁelds and diﬀusion are then decreased sim- ply because they have less time to drift. We simulated monochromatic ﬂats at a range of wavelengths (350 nm, 450 nm, 550 nm, 650 nm, 750 nm, 850 nm and 950 nm) for a sensor of 250 µm. The relative amplitude of the tree ring pattern relative to 350 nm was 1.0, 0.999, 0.997, 0.998, 0.930, and 0.663. This is qualitatively consistent with the measurements of Plazas, Bernstein, & Sheldon (2014) that had no eﬀect for the r and i bands, and a ra- tio of appoximately 0.6 for the z band and 0.4 for the Y band. The wavelength-dependence is smaller for thinner sensors, and it is also aﬀected by other parameters than the thickness to a lesser degree.  8  Peterson et al.  Figure 3. The edge roll oﬀ of a simulated ﬂat with 3 diﬀerent values of the surface charge. The solid, dotted, and dashed lines correspond with surface charge of 0, −2 × 1010, and 2 × 1010.  3.6. Brighter Fatter Eﬀect and Signal vs. Variance  The eﬀect of the accumulated charge on the electric ﬁeld and its inﬂuence over the lateral motion of subse- quent electrons can be seen in two disperate eﬀects: 1) the so-called brighter-fatter eﬀect (Antilogus et al. 2014; Gruen et al. 2015; Rasmussen 2015) and 2) the non- linear relationship between signal and variance in CCDs (Downing et al. 2006, Astier et al. 2019). The brighter- fatter eﬀect refers to the observed sizes of objects being larger the brighter the source. This happens because the distorted electric ﬁeld due to the accumulated charge in the pixels in the core of a particularly bright source, tend to push the subsequent electrons further away. This re- sults in a larger PSF than the source would have if there were not as many photons. This can be seen in Figure 12, where we simulated a series of sources having diﬀerent brightnesses, and plotted the measured PSF size.  The sub-linear relationship between the signal (total number of electrons) and its variance has been noted by Downing et al. (2006). For pure Poisson noise, the vari- ance should be linearly related to the signal. However, it deviates from that relationship as the signal increases. The distortion of the electric ﬁeld due to the accumulated charges can cause this since the pixels that have a larger number of accumulated electrons due to positive statisti- cal ﬂuctuations will tend to induce larger lateral ﬁelds to keep new electrons away from those pixels. This anticor-  relation then tends to decrease the overall variance in the image and eﬀectively smooths out the pattern. Further- more, this eﬀect is intensity-dependent since at low ﬂuxes the distorted electric ﬁelds from accumulated electrons is negligible and then the signal should be equal to the variance. Figure 12 illustrates this by showing the sub- linear behaviour of the variance as a function of signal. We performed a series of ﬂat simulated at diﬀerence in- tensities to measure this eﬀect. The variance then drops to small value as it approaches the full well depth. In this way, these two eﬀects are simultaneously predicted from the physics of accumulated charge ﬁeld distortion. Thus, an intensity-dependent PSF size change of 2% near sat- uration is directly related to a 10% sub-linear variance for 100 µm sensor and is consistent with measurements (Antilogus et al. 2014).  4. CONCLUSION AND FUTURE WORK  We demonstrated that complex non-ideal distortions in sensors can be implemented in an eﬃcient Monte Carlo framework. The simulation of photons incident on a sen- sor followed by the conversion of electrons and their re- sponse to electric ﬁelds can incorporate many of the com- monly observed sensor distortion patterns. Qualtitative results with fringing, ﬁeld-free regions, lithography er- rors, and edge distortion were demonstrated. Tree ring doping variation leads to two related eﬀects. The lateral  Sensor Distortion Effects  9  Figure 4. The PSF size of a grid of stars near the corner of the sensor. The left plot shows a surface charge of 2 × 1010 and the right plot shows a surface charge of −2 × 1010. In both cases, the diﬀusion pattern becomes modiﬁed towards the edge.  Figure 5. The PSF ellipticity of a grid of stars near the corner of the sensor. The left plot shows a surface charge of 2 × 1010 and the right plot shows a surface charge of −2 × 1010. In both case, the ellipticity is tangent to the edge due to the charge being pushed or pulled from the edge.  ﬁeld distortion which causes diﬀerential astrometric er- rors, PSF ellipticity errors, and ﬂat varaiation, whereas the vertical ﬁeld distortion causes PSF size errors. We also demonstrated that intensity-dependent PSFs and sub-linear ﬂat variance are both related to accumulated charges distorting the electric ﬁeld pattern for subse- quent electrons.  Future work will help to establish the accuracy of these methods as well as determine the variation of sensor dis- tortions between diﬀerent devices. There are a number of additional less well-established eﬀects resulting in non- uniformity that may be present in sensors that can be in- corporated into this framework (see e.g. Antilogus et al. 2019). We also have limited this work to sensor eﬀects that aﬀect electrons before the electronic readout sys- tem. PhoSim includes the most important aspects of  these (Peterson et al. 2015), but other details should be included in the future.  We thank the anonymous referee for helpful comments. JRP acknowledges support from Purdue University and the Department of Energy (de-sc00099223). We thank Pierre Astier for helpful conversations.  REFERENCES  Ackermann et al. 2012, ApJS 203, 4. Andersson, K. A., Peterson, J. R., Madejski, G. 2007, ApJ 670,  1010.  Antilogus, P., Astier, P., Doherty, P., Guyonnet, A., & Regnault,  N. 2014, Journal of Instrumentation 9, C03048.  Antilogus, P. 2019, JATIS 5(4), 041506.  10  Peterson et al.  Figure 6. The diﬀerential astronometry pattern of a grid of stars near the corner of the sensor. The left plot shows a surface charge of 2 × 1010 and the right plot shows a surface charge of −2 × 1010. The left plot shows the charge being pushed several pixels from the edge, whereas the right part shows the charge being pulled from the edge.  Astier, P., Antilogus, P., Juramy, C., Le Breton, R., Le Guillou,  L., Sepulveda, E. 2019, A&A 629, A36.  Astier, P. 2015, JINST 10, C05013. Beamer, B., Nomerotski, A., Tsybychev, D. 2015, JINST 10,  Jolissaint, L. 2010, JEOS Vol 5. Lane, R. G., Glindemann, A, & Dainty, J. C. 2002, Waves in  Random Media, Vol. 2, Issue 3.  Le Louarn, M. 2002, Proceedings of Beyond Conventional Optics,  C05027.  217.  Bertin, E. 2009 Moemorie della Societa Astronmica Italiana 80,  Magnier, E. A., Tonry, J. L., Finkbeiner, D. et al. 2018, PASP  422.  130:065002.  Bernstein, G. M., Armstrong, R., Plazas, A. A. et al. 2017, PASP  Metropolis, N., Rosenbluth, A. W., Rosenbluth, M. N., Teller, A.  129, 074053.  Britton, M. C. 2004, Proc. SPIE 5497, 290. Burke, C. et al. 2019, SPIE JARIS 5(3), 038002. Davis, J. et al., SPIE 8443E, 1. Dobke, B. M., Johston, D. E., Massey, R. et al. 2010, PASP 122,  947.  Downing, M., Dietrich, B., Sinclaire, P., Deiries, S., Christen, F.,  2006, Proc. SPIE 6276, 627609.  Ellerbroek, B. L. 2002, Proceedings of the Beyond Conventional  Optics, 229.  H., Teller, E. 1953, J. Chem. Phys. 21, 1087.  Peterson, J. R., Jernigan, J. G., Kahn, S. M. 2004, ApJ 615, 545. Peterson, J. R., Marshall, P. J., Andersson, K. 2007, ApJ 655,  109.  Peterson, J. R. et al. 2015, ApJS 218, 14. Peterson, J. R. et al. 2019, ApJ 873, 98. Plazas, A. A., Bernstein, G. & Sheldon, E. 2014, PASP 126:750P. Pumplin, J. 1969, Amer. Journal of Physics 37, 7. Rasmussen, A. 2015, JINST 10, C05028. Rowe, B. T. P., Jarvis, M., Mandelbaum et al. 2015, Astronomy  Estrada, J., Alvarez, R., Abbott, T. et al. 2010, Proc. SPIE 7735,  & Computing 10, 121.  77351.  Gruen, D., Bernstein, G. M., Jarvis, M., Rowe, B., Vikram, V., Plazas, A. A., & Seitz, S. 2015, Journal of Inst., 10, C05032.  Hastings, W., K. 1970, Biometrika, 57, 97. Holland, S., Groom, D., Palaio, N., Stover, R., & Wei, M. 2003, in  IEEE, Vol. 50, IEEE Transactions on Electron Devices, 225.  Janick, J. & Elliott, T. 1992, Ast. Soc. of Paciﬁc, Vol. 23,  Astronomical CCD Observing and Reduction Techniques, ed. S. B. Howell, 1.  Stubbs, C. 2014, JINST 9, C03032S. Tyson, J. A. 2015, JINST 10, C05022. Wei, M. & Stover, R. J. 1998, Proc. SPIE 3355, Optical  Astronomical Instrumentation.  Sensor Distortion Effects  11  Figure 7. A series of monochromatic ﬂats highlighting diﬀerent aspects of the physics. The ﬂats are generated at 350, 500, 950, and 1000 (clockwise starting from top left). The 350 nm ﬂat shows the ﬁeld free pattern. The 500 nm ﬂat shows the row/column lithography errors and the tree rings. The 950 nm and 1000 nm show the fringing pattern.  Figure 8. The PSF size of a grid of stars on a sensor with a tree ring doping pattern. The left plot is the lateral ﬁeld eﬀect and the right plot is the vertical ﬁeld eﬀect. The modiﬁcation in PSF size is dominated by the vertical ﬁeld eﬀect.  12  Peterson et al.  Figure 9. The PSF ellipticity of a grid of stars on a sensor with a tree ring doping pattern. The left plot is the lateral ﬁeld eﬀect and the right plot is the vertical ﬁeld eﬀect. The PSF ellipticity pattern is dominated by the lateral ﬁeld eﬀect.  Figure 10. The diﬀerential astrometry pattern of a grid of stars on a sensor with a tree ring doping pattern. The left plot is the lateral ﬁeld eﬀect and the right plot is the vertical ﬁeld eﬀect. The astrometry pattern is dominated by the lateral ﬁeld eﬀect.  Sensor Distortion Effects  13  Figure 11. Simulation of a polychromatic ﬂat of a sensor with a tree ring doping pattern. The left plot is the lateral ﬁeld eﬀect and the right plot is the vertical ﬁeld eﬀect. The ﬂat variation is due to the lateral ﬁeld eﬀect.  Figure 12. The observational eﬀects of the distortion of the electric ﬁeld due to accumulated charges on subsequent electrons. The left plot shows the increase in PSF size as a function of the maximum electrons in a given pixel. This demonstrates the intensity-dependent PSF behavior (brighter-fatter eﬀect). The right plot shows the variance of a simulated ﬂat at diﬀerent intensity values. At low intensities the variance is equal to the intensity level as expected for uncorrelated Poisson noise, but at high intensities the electrons get preferentially shifted way from pixels with higher charge resulting in a sub-linear variance.  